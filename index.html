<!DOCTYPE html>
<html lang="ja">
<head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KF4D3SBT');</script>
<!-- End Google Tag Manager -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TOEIC練習問題</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f6f9; margin: 0; padding: 0; }
    .container { max-width: 800px; margin: auto; padding: 20px; }
    h1, h2 { text-align: center; }
    .card { background: white; padding: 20px; margin: 15px 0; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    button { background: #4a90e2; color: white; padding: 10px 20px; margin: 10px 5px; border: none; border-radius: 8px; cursor: pointer; transition: 0.3s; }
    button:hover { background: #357ABD; }
    .hidden { display: none; }
    .choices { margin: 10px 0; }
    .result { background: #fff3cd; padding: 20px; border-radius: 10px; margin-top: 20px; text-align: center; }
    .feedback { margin-top: 10px; padding: 10px; border-radius: 5px; }
    .correct { background-color: #d4edda; }
    .incorrect { background-color: #f8d7da; }
    .bookmark { cursor: pointer; font-size: 24px; float: right; }
    .bookmarked { color: gold; }
    .icon-button { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 120px; height: 120px; margin: 10px; border: none; background: #E6F3FF; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); cursor: pointer; transition: 0.3s; color: black; }
    .icon-button:hover { background: #4a90e2; color: white; transform: translateY(-5px); }
    .icon-button i { font-size: 48px; margin-bottom: 10px; }
    .icon-container { display: flex; justify-content: center; flex-wrap: wrap; }
    .popup { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 5px; opacity: 0; transition: opacity 0.3s; }
    .popup.show { opacity: 1; }
    .bookmarked-question { position: relative; padding: 20px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; }
    .delete-bookmark { position: absolute; top: 10px; right: 10px; cursor: pointer; font-size: 20px; color: #ff4d4d; }
    .confirmation-dialog { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 1000; }
    .confirmation-dialog button { margin: 0 10px; }
    .correct-answer { position: relative; }
    .correct-answer::before {
      content: '◎';
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      color: red;
      font-size: 3em;
      z-index: 1;
    }
    .correct-answer::after {
      content: '';
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 0.6em;
      height: 0.6em;
      background-color: red;
      border-radius: 50%;
      z-index: 2;
    }
    .mistake-card {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 0.25rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .mistake-card h4 {
      margin-top: 0;
    }
    .fixed-top-left-button {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
    }
    .mistake-item {
      position: relative;
      padding-right: 30px;
    }
    .bookmark-icon {
      position: absolute;
      top: 5px;
      right: 5px;
      cursor: pointer;
      font-size: 24px;
      color: #ffd700;
    }
    .level-button {
      margin: 5px;
      padding: 5px 10px;
      background-color: #4a90e2;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .level-button:hover {
      background-color: #3536bd;
    }
    .level-button.active {
      background-color: #3536bd;
      font-weight: bold;
    }
    .category-menu {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .category-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #4a90e2;
    }
    .category-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }
    .mode-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .mode-button {
      flex: 1;
      min-width: 120px;
      padding: 8px 16px;
      background: #e9ecef;
      color: #495057;
      border: 1px solid #ced4da;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .mode-button:hover {
      background: #4a90e2;
      color: white;
      border-color: #4a90e2;
    }
    .tab-container {
      margin-bottom: 20px;
    }
    .tab-buttons {
      display: flex;
      border-bottom: 1px solid #dee2e6;
      margin-bottom: 20px;
    }
    .tab-button {
      flex: 1;
      padding: 12px;
      border: none;
      background: #e9ecef;
      color: #495057;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }
    .tab-button.active {
      background: #4a90e2;
      color: white;
      border-bottom-color: #357ABD;
      font-weight: bold;
    }
    .tab-button:hover {
      background: #4a90e2;
      color: white;
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <h1>TOEIC 練習問題</h1>
    
    <!-- メインメニュー -->
    <div id="main-menu" class="card">
      <h2>メニュー</h2>
      <div class="icon-container">
        <button class="icon-button" onclick="showBookmarks()">
          <i class="fas fa-bookmark"></i>
          ブックマーク
        </button>
        <button class="icon-button" onclick="showStatistics()">
          <i class="fas fa-chart-bar"></i>
          学習統計
        </button>
      </div>
      
      <div class="category-menu">
        <div class="category-card">
          <div class="category-title">
            <i class="fas fa-font"></i> 単語
          </div>
          <div class="mode-buttons">
            <button class="mode-button" onclick="selectMode('vocabulary', 'test')">
              <i class="fas fa-clipboard-list"></i> テストモード
            </button>
            <button class="mode-button" onclick="selectMode('vocabulary', 'training')">
              <i class="fas fa-dumbbell"></i> トレーニングモード
            </button>
          </div>
        </div>
        
        <div class="category-card">
          <div class="category-title">
            <i class="fas fa-pen"></i> ライティング
          </div>
          <div class="mode-buttons">
            <button class="mode-button" onclick="selectMode('writing', 'test')">
              <i class="fas fa-clipboard-list"></i> テストモード
            </button>
            <button class="mode-button" onclick="selectMode('writing', 'training')">
              <i class="fas fa-dumbbell"></i> トレーニングモード
            </button>
          </div>
        </div>
        
        <div class="category-card">
          <div class="category-title">
            <i class="fas fa-headphones"></i> リスニング
          </div>
          <div class="mode-buttons">
            <button class="mode-button" onclick="selectMode('listening', 'test')">
              <i class="fas fa-clipboard-list"></i> テストモード
            </button>
            <button class="mode-button" onclick="selectMode('listening', 'training')">
              <i class="fas fa-dumbbell"></i> トレーニングモード
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- レベル選択 -->
    <div id="level-select" class="card hidden">
      <h2>目標スコアを選択してください</h2>
      <button onclick="selectLevel(300)">300点</button>
      <button onclick="selectLevel(400)">400点</button>
      <button onclick="selectLevel(500)">500点</button>
      <button onclick="selectLevel(600)">600点</button>
      <button onclick="selectLevel(700)">700点</button>
      <button onclick="selectLevel(800)">800点</button>
      <button onclick="selectLevel(900)">900点以上</button>
    </div>
    
    <!-- 出題数選択 -->
    <div id="question-count-select" class="card hidden">
      <h2>出題数を選択してください</h2>
      <p id="selected-info"></p>
      <div class="icon-container">
        <button class="icon-button" onclick="startQuiz(5)">
          <svg width="48" height="48" viewBox="0 0 100 100" fill="currentColor">
            <path d="M20 15 L20 85 L35 75 L50 85 L65 75 L80 85 L80 15 Z" stroke="currentColor" stroke-width="4" fill="none"/>
            <line x1="50" y1="15" x2="50" y2="85" stroke="currentColor" stroke-width="2"/>
            <line x1="30" y1="30" x2="45" y2="30" stroke="currentColor" stroke-width="1.5"/>
            <line x1="30" y1="40" x2="45" y2="40" stroke="currentColor" stroke-width="1.5"/>
            <line x1="55" y1="30" x2="70" y2="30" stroke="currentColor" stroke-width="1.5"/>
            <line x1="55" y1="40" x2="70" y2="40" stroke="currentColor" stroke-width="1.5"/>
          </svg>
          5問
        </button>
        <button class="icon-button" onclick="startQuiz(10)">
          <svg width="48" height="48" viewBox="0 0 100 100" fill="currentColor">
            <path d="M20 15 L20 85 L35 75 L50 85 L65 75 L80 85 L80 15 Z" stroke="currentColor" stroke-width="4" fill="none"/>
            <line x1="50" y1="15" x2="50" y2="85" stroke="currentColor" stroke-width="2"/>
            <line x1="30" y1="30" x2="45" y2="30" stroke="currentColor" stroke-width="1.5"/>
            <line x1="30" y1="40" x2="45" y2="40" stroke="currentColor" stroke-width="1.5"/>
            <line x1="30" y1="50" x2="45" y2="50" stroke="currentColor" stroke-width="1.5"/>
            <line x1="55" y1="30" x2="70" y2="30" stroke="currentColor" stroke-width="1.5"/>
            <line x1="55" y1="40" x2="70" y2="40" stroke="currentColor" stroke-width="1.5"/>
            <line x1="55" y1="50" x2="70" y2="50" stroke="currentColor" stroke-width="1.5"/>
          </svg>
          10問
        </button>
        <button class="icon-button" onclick="startQuiz(15)">
          <svg width="48" height="48" viewBox="0 0 100 100" fill="currentColor">
            <path d="M20 15 L20 85 L35 75 L50 85 L65 75 L80 85 L80 15 Z" stroke="currentColor" stroke-width="4" fill="none"/>
            <line x1="50" y1="15" x2="50" y2="85" stroke="currentColor" stroke-width="2"/>
            <line x1="30" y1="25" x2="45" y2="25" stroke="currentColor" stroke-width="1.5"/>
            <line x1="30" y1="35" x2="45" y2="35" stroke="currentColor" stroke-width="1.5"/>
            <line x1="30" y1="45" x2="45" y2="45" stroke="currentColor" stroke-width="1.5"/>
            <line x1="30" y1="55" x2="45" y2="55" stroke="currentColor" stroke-width="1.5"/>
            <line x1="55" y1="25" x2="70" y2="25" stroke="currentColor" stroke-width="1.5"/>
            <line x1="55" y1="35" x2="70" y2="35" stroke="currentColor" stroke-width="1.5"/>
            <line x1="55" y1="45" x2="70" y2="45" stroke="currentColor" stroke-width="1.5"/>
            <line x1="55" y1="55" x2="70" y2="55" stroke="currentColor" stroke-width="1.5"/>
          </svg>
          15問
        </button>
        <button class="icon-button" onclick="startQuiz(30)">
          <svg width="48" height="48" viewBox="0 0 100 100" fill="currentColor">
            <path d="M20 15 L20 85 L35 75 L50 85 L65 75 L80 85 L80 15 Z" stroke="currentColor" stroke-width="4" fill="none"/>
            <line x1="50" y1="15" x2="50" y2="85" stroke="currentColor" stroke-width="2"/>
            <line x1="25" y1="25" x2="45" y2="25" stroke="currentColor" stroke-width="1"/>
            <line x1="25" y1="30" x2="45" y2="30" stroke="currentColor" stroke-width="1"/>
            <line x1="25" y1="35" x2="45" y2="35" stroke="currentColor" stroke-width="1"/>
            <line x1="25" y1="40" x2="45" y2="40" stroke="currentColor" stroke-width="1"/>
            <line x1="25" y1="45" x2="45" y2="45" stroke="currentColor" stroke-width="1"/>
            <line x1="25" y1="50" x2="45" y2="50" stroke="currentColor" stroke-width="1"/>
            <line x1="25" y1="55" x2="45" y2="55" stroke="currentColor" stroke-width="1"/>
            <line x1="25" y1="60" x2="45" y2="60" stroke="currentColor" stroke-width="1"/>
            <line x1="55" y1="25" x2="75" y2="25" stroke="currentColor" stroke-width="1"/>
            <line x1="55" y1="30" x2="75" y2="30" stroke="currentColor" stroke-width="1"/>
            <line x1="55" y1="35" x2="75" y2="35" stroke="currentColor" stroke-width="1"/>
            <line x1="55" y1="40" x2="75" y2="40" stroke="currentColor" stroke-width="1"/>
            <line x1="55" y1="45" x2="75" y2="45" stroke="currentColor" stroke-width="1"/>
            <line x1="55" y1="50" x2="75" y2="50" stroke="currentColor" stroke-width="1"/>
            <line x1="55" y1="55" x2="75" y2="55" stroke="currentColor" stroke-width="1"/>
            <line x1="55" y1="60" x2="75" y2="60" stroke="currentColor" stroke-width="1"/>
          </svg>
          30問
        </button>
        <button class="icon-button" onclick="startQuizAll()">
          <i class="fas fa-list"></i>
          全問題
        </button>
      </div>
    </div>
    
    <!-- クイズ画面 -->
    <div id="quiz" class="card hidden">
      <h2 id="quiz-title"></h2>
      <span id="bookmark" class="bookmark" onclick="toggleBookmark()">☆</span>
      <div id="question"></div>
      <div id="choices" class="choices"></div>
      <div id="feedback" class="feedback hidden"></div>
      <button id="next-btn" onclick="nextQuestion()" class="hidden">次へ</button>
    </div>
    
    <!-- 結果画面 -->
    <div id="result" class="result hidden"></div>
    
    <!-- ブックマーク一覧 -->
    <div id="bookmarks-list" class="card hidden">
      <h2>ブックマークした問題</h2>
      <div class="tab-container">
        <div class="tab-buttons">
          <button class="tab-button active" onclick="showBookmarkTab('vocabulary')">単語</button>
          <button class="tab-button" onclick="showBookmarkTab('writing')">ライティング</button>
          <button class="tab-button" onclick="showBookmarkTab('listening')">リスニング</button>
        </div>
        <div id="bookmarked-questions"></div>
      </div>
    </div>
    
    <!-- 学習統計 -->
    <div id="statistics" class="card hidden">
      <h2>学習統計</h2>
      <div class="tab-container">
        <div class="tab-buttons">
          <button class="tab-button active" onclick="showStatisticsTab('vocabulary')">単語</button>
          <button class="tab-button" onclick="showStatisticsTab('writing')">ライティング</button>
          <button class="tab-button" onclick="showStatisticsTab('listening')">リスニング</button>
        </div>
        <canvas id="combinedChart"></canvas>
        <div id="mistakesList"></div>
      </div>
    </div>
  </div>
  
  <button id="backToMenuBtn" class="fixed-top-left-button hidden" onclick="handleBackToMenu()">メインメニューに戻る</button>
  <div id="popup" class="popup"></div>
  <div id="confirmation-dialog" class="confirmation-dialog hidden">
    <p>この問題をブックマークから削除しますか？</p>
    <button onclick="confirmDeleteBookmark(true)">はい</button>
    <button onclick="confirmDeleteBookmark(false)">いいえ</button>
  </div>
  <div id="quit-confirmation-dialog" class="confirmation-dialog hidden">
    <p>解答を中断しますか？</p>
    <button onclick="confirmQuit(true)">はい</button>
    <button onclick="confirmQuit(false)">いいえ</button>
  </div>
  
  <script>
    const quizData = {
      vocabulary: {
        300: [
          { q: "I ____ a book.", choices: ["reads", "read", "reading", "to read"], answer: "read", explanation: "主語が'I'の場合、動詞の基本形を使います。" },
          { q: "She ____ happy.", choices: ["is", "are", "am", "be"], answer: "is", explanation: "主語が'She'の場合、be動詞は'is'を使います。" },
          { q: "They ____ soccer.", choices: ["play", "plays", "playing", "played"], answer: "play", explanation: "主語が'They'の場合、動詞の基本形を使います。" },
          { q: "This is my ____.", choices: ["pen", "pens", "pencil", "eraser"], answer: "pen", explanation: "'This is my...'の後には単数形の名詞が来ます。" },
          { q: "We ____ to school.", choices: ["go", "goes", "going", "went"], answer: "go", explanation: "主語が'We'の場合、動詞の基本形を使います。" },
        ],
        400: [
          { q: "He ____ to school yesterday.", choices: ["go", "goes", "went", "going"], answer: "went", explanation: "'yesterday'は過去を示すので、動詞の過去形を使います。" },
          { q: "We ____ lunch now.", choices: ["eat", "eats", "eating", "are eating"], answer: "are eating", explanation: "'now'は現在進行形を示すので、'are eating'を使います。" },
          { q: "She ____ TV every day.", choices: ["watch", "watches", "watched", "watching"], answer: "watches", explanation: "主語が'She'で習慣を表す場合、動詞の三人称単数現在形を使います。" },
          { q: "I ____ a letter tomorrow.", choices: ["write", "writes", "wrote", "will write"], answer: "will write", explanation: "'tomorrow'は未来を示すので、'will + 動詞の原形'を使います。" },
          { q: "They ____ tennis last Sunday.", choices: ["play", "played", "plays", "playing"], answer: "played", explanation: "'last Sunday'は過去を示すので、動詞の過去形を使います。" },
        ],
      },
      writing: {
        300: [
          { q: "次の文を完成させてください: 'I am ____ a report.'", choices: ["write", "writes", "writing", "wrote"], answer: "writing", explanation: "現在進行形では'be動詞 + 動詞のing形'を使います。" },
          { q: "正しい語順を選んでください: 'yesterday / I / a letter / wrote'", choices: ["I wrote a letter yesterday", "Yesterday wrote I a letter", "A letter I wrote yesterday", "Wrote I yesterday a letter"], answer: "I wrote a letter yesterday", explanation: "英語の基本語順は'主語 + 動詞 + 目的語 + 時を表す副詞'です。" },
          { q: "適切な前置詞を選んでください: 'I live ____ Tokyo.'", choices: ["in", "on", "at", "by"], answer: "in", explanation: "都市名の前には前置詞'in'を使います。" },
          { q: "複数形にしてください: 'child'", choices: ["childs", "children", "childes", "child"], answer: "children", explanation: "'child'の複数形は不規則変化で'children'です。" },
          { q: "比較級を作ってください: 'big'", choices: ["more big", "bigger", "biger", "bigest"], answer: "bigger", explanation: "短い形容詞の比較級は語尾に'-er'をつけます。'big'は'bigger'になります。" },
        ],
        400: [
          { q: "間接疑問文を完成させてください: 'I don't know ____.'", choices: ["where is he", "where he is", "where does he", "where he does"], answer: "where he is", explanation: "間接疑問文では疑問詞の後は平叙文の語順になります。" },
          { q: "受動態に変えてください: 'Tom wrote this letter.'", choices: ["This letter was written by Tom", "This letter wrote by Tom", "This letter is written by Tom", "Tom was written this letter"], answer: "This letter was written by Tom", explanation: "受動態は'be動詞 + 過去分詞 + by + 行為者'の形になります。" },
          { q: "関係代名詞を使って文を完成させてください: 'This is the book ____ I bought yesterday.'", choices: ["who", "which", "where", "when"], answer: "which", explanation: "物を先行詞とする場合、関係代名詞は'which'を使います。" },
          { q: "仮定法を使って文を完成させてください: 'If I ____ rich, I would travel around the world.'", choices: ["am", "was", "were", "will be"], answer: "were", explanation: "仮定法過去では、主語に関係なくbe動詞は'were'を使います。" },
          { q: "現在完了形を完成させてください: 'I ____ this movie before.'", choices: ["see", "saw", "have seen", "will see"], answer: "have seen", explanation: "現在完了形は'have/has + 過去分詞'の形で、経験を表します。" },
        ],
      },
      listening: {
        300: [
          { q: "音声：'Where is the library?' この質問に対する適切な答えは？", choices: ["It's next to the bank", "It's 3 o'clock", "It's very big", "It's my book"], answer: "It's next to the bank", explanation: "'Where'で場所を聞いているので、場所を答える必要があります。" },
          { q: "音声：'What time is it?' この質問に対する適切な答えは？", choices: ["It's Monday", "It's sunny", "It's 2:30", "It's a clock"], answer: "It's 2:30", explanation: "'What time'で時刻を聞いているので、時刻を答える必要があります。" },
          { q: "音声：'How are you?' この質問に対する適切な答えは？", choices: ["I'm fine, thank you", "I'm 20 years old", "I'm a student", "I'm from Japan"], answer: "I'm fine, thank you", explanation: "'How are you?'は体調や気分を聞く挨拶なので、'I'm fine'で答えます。" },
          { q: "音声：'Can you help me?' この質問に対する適切な答えは？", choices: ["Yes, I can", "No, I don't", "Yes, I do", "No, I won't"], answer: "Yes, I can", explanation: "'Can you...?'の質問には'Yes, I can'または'No, I can't'で答えます。" },
          { q: "音声：'Do you like coffee?' この質問に対する適切な答えは？", choices: ["Yes, I like", "Yes, I do", "Yes, I am", "Yes, I can"], answer: "Yes, I do", explanation: "'Do you...?'の質問には'Yes, I do'または'No, I don't'で答えます。" },
        ],
        400: [
          { q: "音声：'I'm looking for a restaurant. Where should I go?' この状況で最も適切な返答は？", choices: ["There's a good one on Main Street", "I don't like restaurants", "It's expensive", "You should eat at home"], answer: "There's a good one on Main Street", explanation: "レストランを探している人に対して、具体的な場所を教えるのが適切です。" },
          { q: "音声：'Excuse me, is this seat taken?' この質問に対する適切な答えは？", choices: ["No, please sit down", "Yes, it's a chair", "No, it's standing", "Yes, I took it"], answer: "No, please sit down", explanation: "席が空いているかを聞かれているので、空いていれば'No, please sit down'と答えます。" },
          { q: "音声：'Could you tell me how to get to the station?' この質問に対する適切な答えは？", choices: ["Go straight and turn left", "The station is big", "I don't have a car", "It takes one hour"], answer: "Go straight and turn left", explanation: "道順を聞かれているので、具体的な道順を教える必要があります。" },
          { q: "音声：'Would you like some coffee?' この質問に対する適切な答えは？", choices: ["Yes, please", "Yes, I like", "Yes, I want", "Yes, I need"], answer: "Yes, please", explanation: "'Would you like...?'の丁寧な申し出には'Yes, please'で答えるのが適切です。" },
          { q: "音声：'I'm sorry I'm late.' この発言に対する適切な返答は？", choices: ["That's all right", "You're welcome", "Thank you", "Excuse me"], answer: "That's all right", explanation: "謝罪に対しては'That's all right'や'Don't worry about it'で応答します。" },
        ],
      }
    };

    let currentMode, currentCategory, currentLevel, currentQuestion, score, selectedQuestionCount;
    let bookmarks = JSON.parse(localStorage.getItem('bookmarks')) || { vocabulary: [], writing: [], listening: [] };
    let bookmarkToDelete = null;
    let statistics = JSON.parse(localStorage.getItem('statistics')) || {};
    let mistakes = JSON.parse(localStorage.getItem('mistakes')) || {};
    let currentBookmarkTab = 'vocabulary';
    let currentStatisticsTab = 'vocabulary';
    let currentQuestions = []; // 出題される問題のリスト

    function showMainMenu() {
      hideAllSections();
      document.getElementById("main-menu").classList.remove("hidden");
      document.getElementById("backToMenuBtn").classList.add("hidden");
    }

    function hideAllSections() {
      const sections = ["main-menu", "level-select", "question-count-select", "quiz", "result", "bookmarks-list", "statistics", "backToMenuBtn"];
      sections.forEach(section => document.getElementById(section).classList.add("hidden"));
    }

    function selectMode(category, mode) {
      currentCategory = category;
      currentMode = mode;
      hideAllSections();
      document.getElementById("level-select").classList.remove("hidden");
      document.getElementById("backToMenuBtn").classList.remove("hidden");
    }

    function selectLevel(level) {
      currentLevel = level;
      hideAllSections();
      document.getElementById("question-count-select").classList.remove("hidden");
      document.getElementById("selected-info").textContent = `${getCategoryName(currentCategory)} - ${currentMode === 'test' ? 'テスト' : 'トレーニング'}モード - 目標スコア: ${level}点`;
      document.getElementById("backToMenuBtn").classList.remove("hidden");
    }

    function startQuiz(questionCount) {
      selectedQuestionCount = questionCount;
      currentQuestion = 0;
      score = 0;
      
      // 問題をシャッフルして指定された数だけ選択
      const allQuestions = [...quizData[currentCategory][currentLevel]];
      currentQuestions = shuffleArray(allQuestions).slice(0, questionCount);
      
      hideAllSections();
      document.getElementById("quiz").classList.remove("hidden");
      document.getElementById("quiz-title").textContent = `${getCategoryName(currentCategory)} - 目標スコア: ${currentLevel}点 - ${currentMode === 'test' ? 'テスト' : 'トレーニング'}モード (${questionCount}問)`;
      document.getElementById("backToMenuBtn").classList.remove("hidden");
      showQuestion();
    }

    function startQuizAll() {
      const allQuestions = quizData[currentCategory][currentLevel];
      startQuiz(allQuestions.length);
    }

    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    function getCategoryName(category) {
      const names = { vocabulary: '単語', writing: 'ライティング', listening: 'リスニング' };
      return names[category] || category;
    }

    function showQuestion() {
      const qData = currentQuestions[currentQuestion];
      document.getElementById("question").textContent = qData.q;
      const choicesDiv = document.getElementById("choices");
      choicesDiv.innerHTML = "";
      qData.choices.forEach(choice => {
        const btn = document.createElement("button");
        btn.textContent = choice;
        btn.onclick = () => checkAnswer(choice);
        choicesDiv.appendChild(btn);
      });
      document.getElementById("feedback").classList.add("hidden");
      document.getElementById("next-btn").classList.add("hidden");
      updateBookmarkStatus();
    }

    function checkAnswer(choice) {
      const qData = currentQuestions[currentQuestion];
      const isCorrect = choice === qData.answer;
      
      updateStatistics(currentCategory, currentLevel, isCorrect, qData.q);
      
      if (isCorrect) {
        score++;
      }
      
      if (currentMode === 'test') {
        qData.userAnswerIndex = qData.choices.indexOf(choice);
        nextQuestion();
      } else {
        const feedbackDiv = document.getElementById("feedback");
        feedbackDiv.textContent = isCorrect ? "正解です！" : "不正解です。";
        feedbackDiv.textContent += " " + qData.explanation;
        feedbackDiv.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
        feedbackDiv.classList.remove("hidden");
        document.getElementById("next-btn").classList.remove("hidden");
        Array.from(document.getElementById("choices").children).forEach(btn => {
          btn.disabled = true;
          if (btn.textContent === qData.answer) {
            btn.classList.add("correct-answer");
          }
        });
      }
    }

    function nextQuestion() {
      currentQuestion++;
      if (currentQuestion < currentQuestions.length) {
        showQuestion();
      } else {
        showResult();
      }
    }

    function showResult() {
      hideAllSections();
      const resultDiv = document.getElementById("result");
      resultDiv.classList.remove("hidden");
      const total = currentQuestions.length;
      const percentage = Math.round((score / total) * 100);
      let feedback = "";
      if (percentage >= 80) feedback = "素晴らしい！目標達成圏内です！";
      else if (percentage >= 50) feedback = "あと少しで目標に届きます。頑張りましょう！";
      else feedback = "基礎を復習しましょう。継続が力になります！";
      
      let resultHTML = `<h2>結果 - ${getCategoryName(currentCategory)}</h2><p>${score}/${total} 正解 (${percentage}%)</p><p>${feedback}</p>`;
      
      if (currentMode === 'test') {
        resultHTML += '<h3>回答詳細:</h3>';
        currentQuestions.forEach((q, index) => {
          const userAnswer = q.choices[q.userAnswerIndex];
          const isCorrect = userAnswer === q.answer;
          resultHTML += `
            <div class="${isCorrect ? 'correct' : 'incorrect'}">
              <p><strong>問題 ${index + 1}:</strong> ${q.q}</p>
              <p>あなたの回答: ${userAnswer}</p>
              <p>正解: ${q.answer}</p>
              <p>解説: ${q.explanation}</p>
            </div>
          `;
        });
      }
      
      resultHTML += `<button onclick="showMainMenu()">メインメニューに戻る</button>`;
      resultDiv.innerHTML = resultHTML;
      document.getElementById("backToMenuBtn").classList.remove("hidden");
    }

    function toggleBookmark() {
      const currentQ = currentQuestions[currentQuestion];
      const bookmarkIndex = bookmarks[currentCategory].findIndex(b => b.q === currentQ.q);
      if (bookmarkIndex === -1) {
        bookmarks[currentCategory].push({ ...currentQ, level: currentLevel, category: currentCategory });
        showPopup("ブックマークに登録されました");
      } else {
        bookmarks[currentCategory].splice(bookmarkIndex, 1);
        showPopup("ブックマークから削除しました");
      }
      localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
      updateBookmarkStatus();
    }

    function updateBookmarkStatus() {
      const currentQ = currentQuestions[currentQuestion];
      const isBookmarked = bookmarks[currentCategory].some(b => b.q === currentQ.q);
      const bookmarkElement = document.getElementById("bookmark");
      bookmarkElement.textContent = isBookmarked ? "★" : "☆";
      bookmarkElement.className = isBookmarked ? "bookmark bookmarked" : "bookmark";
    }

    function showBookmarks() {
      hideAllSections();
      document.getElementById("bookmarks-list").classList.remove("hidden");
      document.getElementById("backToMenuBtn").classList.remove("hidden");
      showBookmarkTab('vocabulary');
    }

    function showBookmarkTab(category) {
      currentBookmarkTab = category;
      
      // タブボタンのアクティブ状態を更新
      document.querySelectorAll('#bookmarks-list .tab-button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.includes(getCategoryName(category))) {
          btn.classList.add('active');
        }
      });
      
      const bookmarksListDiv = document.getElementById("bookmarked-questions");
      const categoryBookmarks = bookmarks[category] || [];
      
      if (categoryBookmarks.length > 0) {
        const levels = [...new Set(categoryBookmarks.map(b => b.level))].sort((a, b) => a - b);
        
        let html = `<h3>${getCategoryName(category)}のブックマーク</h3>`;
        
        if (levels.length > 1) {
          html += '<div id="level-buttons-container"></div>';
          bookmarksListDiv.innerHTML = html;
          
          const buttonContainer = document.getElementById('level-buttons-container');
          levels.forEach(level => {
            const button = document.createElement('button');
            button.textContent = `レベル ${level}`;
            button.className = 'level-button';
            button.onclick = () => showBookmarksForLevel(category, level);
            buttonContainer.appendChild(button);
          });
          showBookmarksForLevel(category, levels[0]);
        } else if (levels.length === 1) {
          bookmarksListDiv.innerHTML = html;
          showBookmarksForLevel(category, levels[0]);
        }
      } else {
        bookmarksListDiv.innerHTML = `<h3>${getCategoryName(category)}のブックマーク</h3><p>ブックマークした問題がありません。</p>`;
      }
    }

    function showBookmarksForLevel(category, level) {
      const bookmarksListDiv = document.getElementById("bookmarked-questions");
      const bookmarksContent = document.createElement('div');
      bookmarksContent.id = 'bookmarksContent';
      const levelBookmarks = bookmarks[category].filter(b => b.level === level);
      
      if (levelBookmarks.length > 0) {
        bookmarksContent.innerHTML = `
          <div class="bookmarks-card">
            <h4>${getCategoryName(category)} - レベル ${level}</h4>
            ${levelBookmarks.map((q, index) => `
              <div class="bookmarked-question">
                <span class="delete-bookmark" onclick="deleteBookmark('${category}', ${bookmarks[category].indexOf(q)})">×</span>
                <h3>問題 ${index + 1}</h3>
                <p>${q.q}</p>
                <p>正解: ${q.answer}</p>
                <p>解説: ${q.explanation}</p>
              </div>
            `).join('')}
          </div>
        `;
      } else {
        bookmarksContent.innerHTML = `<p>このレベルにはブックマークした問題がありません。</p>`;
      }
      
      // 既存のコンテンツを置き換える
      const existingContent = document.getElementById('bookmarksContent');
      if (existingContent) {
        existingContent.remove();
      }
      bookmarksListDiv.appendChild(bookmarksContent);
      
      // アクティブなボタンのスタイルを更新
      document.querySelectorAll('.level-button').forEach(btn => {
        btn.classList.toggle('active', btn.textContent === `レベル ${level}`);
      });
    }

    function deleteBookmark(category, index) {
      bookmarkToDelete = { category, index };
      document.getElementById("confirmation-dialog").classList.remove("hidden");
    }

    function confirmDeleteBookmark(confirmed) {
      if (confirmed && bookmarkToDelete !== null) {
        bookmarks[bookmarkToDelete.category].splice(bookmarkToDelete.index, 1);
        localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
        showBookmarkTab(bookmarkToDelete.category);
        showPopup("ブックマークから削除しました");
      }
      document.getElementById("confirmation-dialog").classList.add("hidden");
      bookmarkToDelete = null;
    }

    function showPopup(message) {
      const popup = document.getElementById("popup");
      popup.textContent = message;
      popup.classList.add("show");
      setTimeout(() => {
        popup.classList.remove("show");
      }, 2000);
    }

    function handleBackToMenu() {
      // ブックマーク or 統計画面なら確認なしで即戻る
      if (!document.getElementById("bookmarks-list").classList.contains("hidden") ||
          !document.getElementById("statistics").classList.contains("hidden")) {
        showMainMenu();
        return;
      }
      if (currentMode === 'test' || currentMode === 'training') {
        confirmQuit();
      } else {
        showMainMenu();
      }
    }

    function confirmQuit(confirmed = null) {
      const dialog = document.getElementById("quit-confirmation-dialog");
      if (confirmed === null) {
        // 最初にボタンを押したとき → 確認ダイアログを表示
        if (currentMode === 'test' || currentMode === 'training') {
          dialog.classList.remove("hidden");
        } else {
          showMainMenu();
        }
      } else {
        // 「はい / いいえ」クリック後
        dialog.classList.add("hidden");
        if (confirmed) {
          showMainMenu();
        }
      }
    }

    function updateStatistics(category, level, isCorrect, question) {
      const key = `${category}_${level}`;
      if (!statistics[key]) {
        statistics[key] = { total: 0, correct: 0, category: category, level: level };
      }
      statistics[key].total++;
      if (isCorrect) {
        statistics[key].correct++;
      } else {
        const mistakeKey = `${category}_${level}`;
        if (!mistakes[mistakeKey]) {
          mistakes[mistakeKey] = {};
        }
        if (!mistakes[mistakeKey][question]) {
          mistakes[mistakeKey][question] = 0;
        }
        mistakes[mistakeKey][question]++;
      }
      localStorage.setItem('statistics', JSON.stringify(statistics));
      localStorage.setItem('mistakes', JSON.stringify(mistakes));
    }

    function showStatistics() {
      hideAllSections();
      // 最新データを毎回再取得
      statistics = JSON.parse(localStorage.getItem('statistics')) || {};
      mistakes = JSON.parse(localStorage.getItem('mistakes')) || {};
      document.getElementById("statistics").classList.remove("hidden");
      document.getElementById("backToMenuBtn").classList.remove("hidden");
      showStatisticsTab('vocabulary');
    }

    function showStatisticsTab(category) {
      currentStatisticsTab = category;
      
      // タブボタンのアクティブ状態を更新
      document.querySelectorAll('#statistics .tab-button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.includes(getCategoryName(category))) {
          btn.classList.add('active');
        }
      });
      
      // カテゴリ別の統計データを取得
      const categoryStats = Object.keys(statistics)
        .filter(key => key.startsWith(category + '_'))
        .map(key => statistics[key]);
      
      if (categoryStats.length > 0) {
        const levels = categoryStats.map(stat => stat.level);
        const totalQuestions = categoryStats.map(stat => stat.total);
        const accuracyRates = categoryStats.map(stat => (stat.correct / stat.total * 100).toFixed(2));
        
        // Chart.js 再描画前に古いチャートを削除
        if (window.combinedChartInstance) {
          window.combinedChartInstance.destroy();
        }
        
        window.combinedChartInstance = new Chart(document.getElementById('combinedChart'), {
          type: 'bar',
          data: {
            labels: levels.map(l => `${l}点`),
            datasets: [
              {
                label: '解答した問題数',
                data: totalQuestions,
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                yAxisID: 'y-axis-1'
              },
              {
                label: '正答率',
                data: accuracyRates,
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                type: 'line',
                yAxisID: 'y-axis-2',
                fill: false
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              'y-axis-1': {
                type: 'linear',
                position: 'left',
                beginAtZero: true,
                title: { display: true, text: '解答した問題数' }
              },
              'y-axis-2': {
                type: 'linear',
                position: 'right',
                beginAtZero: true,
                max: 100,
                title: { display: true, text: '正答率 (%)' }
              }
            },
            plugins: {
              title: { display: true, text: `${getCategoryName(category)} - レベル別解答数と正答率` },
              tooltip: { mode: 'index', intersect: false }
            },
            hover: { mode: 'nearest', intersect: true }
          }
        });
      } else {
        // データがない場合
        if (window.combinedChartInstance) {
          window.combinedChartInstance.destroy();
        }
        document.getElementById('combinedChart').getContext('2d').clearRect(0, 0, document.getElementById('combinedChart').width, document.getElementById('combinedChart').height);
      }
      
      showTopMistakesButtons(category);
    }

    function showTopMistakesButtons(category) {
      const mistakesListDiv = document.getElementById('mistakesList');
      mistakesListDiv.innerHTML = `<h3>${getCategoryName(category)}で間違えた問題トップ3</h3>`;
      
      const categoryMistakeKeys = Object.keys(mistakes).filter(key => key.startsWith(category + '_'));
      
      if (categoryMistakeKeys.length > 0) {
        const buttonContainer = document.createElement('div');
        categoryMistakeKeys.forEach(mistakeKey => {
          const level = mistakeKey.split('_')[1];
          const button = document.createElement('button');
          button.textContent = `レベル ${level}`;
          button.className = 'level-button';
          button.onclick = () => showTopMistakesForLevel(category, level);
          buttonContainer.appendChild(button);
        });
        mistakesListDiv.appendChild(buttonContainer);
        
        // 最初のレベルの間違えた問題を表示
        const firstLevel = categoryMistakeKeys[0].split('_')[1];
        showTopMistakesForLevel(category, firstLevel);
      } else {
        mistakesListDiv.innerHTML += `<p>${getCategoryName(category)}にはまだ間違えた問題がありません。</p>`;
      }
    }

    function showTopMistakesForLevel(category, level) {
      const mistakesListDiv = document.getElementById('mistakesList');
      const mistakeKey = `${category}_${level}`;
      const levelMistakes = mistakes[mistakeKey] ? Object.entries(mistakes[mistakeKey])
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3) : [];
      
      const mistakesContent = document.createElement('div');
      mistakesContent.id = 'mistakesContent';
      
      if (levelMistakes.length > 0) {
        mistakesContent.innerHTML = `
          <div class="mistake-card">
            <h4>${getCategoryName(category)} - レベル ${level}</h4>
            ${levelMistakes.map(([question, count]) => {
              const questionData = quizData[category][level].find(q => q.q === question);
              const isBookmarked = bookmarks[category].some(b => b.q === question);
              return `
                <div class="mistake-item">
                  <span class="bookmark-icon" onclick="toggleBookmarkFromMistakes('${category}', '${level}', '${question}')">${isBookmarked ? '★' : '☆'}</span>
                  <p><strong>問題:</strong> ${question}</p>
                  <p><strong>間違えた回数:</strong> ${count}</p>
                  <p><strong>正解:</strong> ${questionData.answer}</p>
                  <p><strong>解説:</strong> ${questionData.explanation}</p>
                </div>
              `;
            }).join('<hr>')}
          </div>
        `;
      } else {
        mistakesContent.innerHTML = `<p>このレベルにはまだ間違えた問題がありません。</p>`;
      }
      
      // 既存のコンテンツを置き換える
      const existingContent = document.getElementById('mistakesContent');
      if (existingContent) {
        existingContent.remove();
      }
      mistakesListDiv.appendChild(mistakesContent);
      
      // アクティブなボタンのスタイルを更新
      document.querySelectorAll('.level-button').forEach(btn => {
        btn.classList.toggle('active', btn.textContent === `レベル ${level}`);
      });
    }

    function toggleBookmarkFromMistakes(category, level, question) {
      const questionData = quizData[category][level].find(q => q.q === question);
      const bookmarkIndex = bookmarks[category].findIndex(b => b.q === question);
      
      if (bookmarkIndex === -1) {
        bookmarks[category].push({ ...questionData, level: level, category: category });
        showPopup("ブックマークに登録されました");
      } else {
        bookmarks[category].splice(bookmarkIndex, 1);
        showPopup("ブックマークから削除しました");
      }
      localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
      showTopMistakesForLevel(category, level); // 表示を更新
    }

    // 初期化時にブックマークデータの構造を確認・修正
    function initializeBookmarks() {
      let bookmarks = JSON.parse(localStorage.getItem('bookmarks')) || {};
      
      // 古い形式（配列）の場合は新しい形式（オブジェクト）に変換
      if (Array.isArray(bookmarks)) {
        const newBookmarksFormat = { vocabulary: bookmarks, writing: [], listening: [] };
        localStorage.setItem('bookmarks', JSON.stringify(newBookmarksFormat));
        return newBookmarksFormat;
      }
      
      // 新しい形式だが、プロパティが不足している場合は追加
      if (!bookmarks.vocabulary) bookmarks.vocabulary = [];
      if (!bookmarks.writing) bookmarks.writing = [];
      if (!bookmarks.listening) bookmarks.listening = [];
      
      localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
      return bookmarks;
    }

    // アプリ開始時にブックマークを初期化
    bookmarks = initializeBookmarks();
    
    showMainMenu();
  </script>
  <script src="quizData_300.js"></script>
</body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KF4D3SBT"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
</html>
